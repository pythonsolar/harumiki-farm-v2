<!-- strawberry/templates/strawberry/compare.html -->
{% extends 'strawberry/base.html' %}
{% load static %}

{% block title %}Compare GH1 & GH2 - Harumiki Smart Farm{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/compare.css' %}">
{% endblock %}

{% block page_title %}
<div class="title-with-icon">
    <div class="title-icon compare">
        <i class="bi bi-bar-chart-line"></i>
    </div>
    <div>
        <h1 class="page-title">
            <span class="title-prefix">Data Analysis</span>
            <span class="title-main gradient-text">Compare GH1 & GH2</span>
        </h1>
        <p class="page-subtitle">Side-by-side Performance Comparison</p>
    </div>
</div>
{% endblock %}

{% block page_controls %}
<div class="btn-group" role="group">
    <a href="{% url 'farm-1' %}" class="btn btn-outline-primary">
        <i class="bi bi-building me-1"></i>
        GH1 Dashboard
    </a>
    <a href="{% url 'farm-2' %}" class="btn btn-outline-primary">
        <i class="bi bi-building me-1"></i>
        GH2 Dashboard
    </a>
</div>
{% endblock %}

{% block content %}
<div class="compare-container">
    <!-- Date Selection -->
    <div class="filter-card">
        <h2 class="filter-title">
            <i class="bi bi-calendar3"></i>
            COMPARE Data GH1&GH2
        </h2>
        
        <form method="GET" action="{% url 'compare' %}" class="filter-form" novalidate>
            {% csrf_token %}
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label class="form-label" for="monthSelect">Month:</label>
                    <select name="month" class="form-select" id="monthSelect" required 
                            aria-describedby="monthHelp">
                        <option value="0" {% if current_month == 0 %}selected{% endif %}>January</option>
                        <option value="1" {% if current_month == 1 %}selected{% endif %}>February</option>
                        <option value="2" {% if current_month == 2 %}selected{% endif %}>March</option>
                        <option value="3" {% if current_month == 3 %}selected{% endif %}>April</option>
                        <option value="4" {% if current_month == 4 %}selected{% endif %}>May</option>
                        <option value="5" {% if current_month == 5 %}selected{% endif %}>June</option>
                        <option value="6" {% if current_month == 6 %}selected{% endif %}>July</option>
                        <option value="7" {% if current_month == 7 %}selected{% endif %}>August</option>
                        <option value="8" {% if current_month == 8 %}selected{% endif %}>September</option>
                        <option value="9" {% if current_month == 9 %}selected{% endif %}>October</option>
                        <option value="10" {% if current_month == 10 %}selected{% endif %}>November</option>
                        <option value="11" {% if current_month == 11 %}selected{% endif %}>December</option>
                    </select>
                    <div id="monthHelp" class="form-text">Select month for data comparison</div>
                </div>
                <div class="col-md-5">
                    <label class="form-label" for="yearInput">Year:</label>
                    <input type="number" name="year" class="form-control" id="yearInput"
                           value="{{ year|escape }}" min="2020" max="{% now 'Y'|add:1 %}" 
                           required aria-describedby="yearHelp">
                    <div id="yearHelp" class="form-text">Enter year (2020-{% now 'Y'|add:1 %})</div>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100" 
                            aria-describedby="submitHelp">
                        <span class="btn-text">
                            <i class="bi bi-search me-1" aria-hidden="true"></i>
                            Submit
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                            Loading...
                        </span>
                    </button>
                    <div id="submitHelp" class="form-text">Apply date filter</div>
                </div>
            </div>
        </form>
        
        <!-- Date Range Display -->
        <div class="date-range-display">
            <div class="date-info">
                <strong>First Day:</strong> 
                <span class="date-value">{{ first_date }}T00:00:00</span>
            </div>
            <div class="date-info">
                <strong>Last Day:</strong> 
                <span class="date-value">{{ last_date }}T23:59:59</span>
            </div>
        </div>
    </div>

    <!-- Chart Selection Section -->
    <div class="chart-selection-card">
        <h2 class="selection-title">
            <i class="bi bi-graph-up"></i>
            Select Chart to Display
        </h2>
        
        <div class="chart-selector-form">
            <div class="row align-items-end">
                <div class="col-md-8">
                    <label class="form-label" for="chartSelect">
                        <i class="bi bi-bar-chart-line me-1"></i>
                        Chart Type:
                    </label>
                    <select id="chartSelect" class="form-select chart-select" 
                            aria-describedby="chartHelp">
                        <option value="" disabled selected>Choose a chart to display...</option>
                        <option value="pm" data-title="PM 2.5 (Œºg/m¬≥)" data-priority="1">
                            üå´Ô∏è PM 2.5 (Œºg/m¬≥)
                        </option>
                        <option value="co2" data-title="Carbon dioxide (ppm)" data-priority="1">
                            ü´ß Carbon dioxide (ppm)
                        </option>
                        <option value="luxuv" data-title="LUX (lux) & UV (nm)" data-priority="2">
                            ‚òÄÔ∏è LUX (lux) & UV (nm)
                        </option>
                        <option value="ppfd" data-title="PPFD (Œºmol/s.m¬≤)" data-priority="2">
                            üí° PPFD (Œºmol/s.m¬≤)
                        </option>
                        <option value="nitrogen" data-title="Nitrogen in soil" data-priority="3">
                            üå± Nitrogen in soil
                        </option>
                        <option value="phosphorus" data-title="Phosphorus in soil" data-priority="3">
                            üß™ Phosphorus in soil
                        </option>
                        <option value="potassium" data-title="Potassium in soil" data-priority="3">
                            ‚öóÔ∏è Potassium in soil
                        </option>
                        <option value="tempsoil" data-title="Temperature (¬∞C) [Soil]" data-priority="3">
                            üå°Ô∏è Temperature (¬∞C) [Soil]
                        </option>
                        <option value="tempairwater" data-title="Temperature (¬∞C) [Air & Water]" data-priority="2">
                            üå°Ô∏è Temperature (¬∞C) [Air & Water]
                        </option>
                        <option value="humidity" data-title="Humidity (%) [Air]" data-priority="2">
                            üíß Humidity (%) [Air]
                        </option>
                        <option value="moisture" data-title="Moisture (%) [Soil]" data-priority="4">
                            üåä Moisture (%) [Soil]
                        </option>
                        <option value="ec" data-title="Electrical Conductivity (¬µS/cm)" data-priority="1">
                            ‚ö° Electrical Conductivity (¬µS/cm)
                        </option>
                    </select>
                    <div id="chartHelp" class="form-text">
                        Select a sensor type to compare data between GH1 and GH2
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="button" id="loadChartBtn" class="btn btn-primary w-100" 
                            disabled aria-describedby="loadHelp">
                        <span class="btn-text">
                            <i class="bi bi-play-fill me-1" aria-hidden="true"></i>
                            Load Chart
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                            Loading...
                        </span>
                    </button>
                    <div id="loadHelp" class="form-text">Click to load selected chart</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Single Chart Display Section -->
    <div class="chart-display-section" id="chartDisplaySection" style="display: none;">
        <div class="chart-container" id="dynamicChartContainer">
            <div class="chart-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 id="chartTitle">Select a chart to display</h3>
                    <div class="chart-actions">
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                id="refreshChartBtn" title="Refresh Chart">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" 
                                id="fullscreenBtn" title="Fullscreen">
                            <i class="bi bi-arrows-fullscreen"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="chart-body" id="dynamicChartBody" data-chart-loaded="false">
                <div class="chart-placeholder">
                    <div class="placeholder-content">
                        <i class="bi bi-graph-up placeholder-icon"></i>
                        <h4>Ready to Load Chart</h4>
                        <p>Select a chart type from the dropdown above and click "Load Chart" to begin</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart data will be loaded dynamically via AJAX -->
    <div id="chart-data" class="d-none" 
         role="region" aria-label="Chart data storage"
         data-date-range="{{ first_date }}|{{ last_date }}"
         data-month="{{ month }}"
         data-year="{{ year }}">
    </div>
    
    <!-- Performance monitoring -->
    <div id="performance-info" class="d-none" 
         data-page-load="{{ request.resolver_match.view_name }}"
         data-user-agent="{{ request.META.HTTP_USER_AGENT|slice:':100'|escapejs }}">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/compare-selective.js' %}?v=3.9"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Compare page loaded');
    
    // Wait for Chart.js to be available
    function waitForChartJS() {
        if (typeof Chart !== 'undefined') {
            console.log('‚úÖ Chart.js available, initializing compare page...');
            
            // Initialize the page
            if (typeof initializeComparePage !== 'undefined') {
                initializeComparePage();
            } else {
                console.error('‚ùå initializeComparePage function not found');
            }
        } else {
            console.log('‚è≥ Waiting for Chart.js...');
            setTimeout(waitForChartJS, 200);
        }
    }
    
    // Start waiting for Chart.js
    waitForChartJS();
});
</script>
{% endblock %}