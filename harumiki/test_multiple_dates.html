<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Multiple Dates Display</title>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; }
        .info { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #ffeaa7; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Testing Multiple Dates Display</h1>
        
        <div class="info">
            <h3>üìÖ Expected Behavior:</h3>
            <ul>
                <li><strong>First & Last:</strong> Always show first and last dates</li>
                <li><strong>New Days:</strong> Show every time the date changes</li>
                <li><strong>Same Day:</strong> Show some intermediate points to avoid empty axis</li>
            </ul>
        </div>

        <div class="chart-container">
            <canvas id="testChart"></canvas>
        </div>
        
        <!-- Test data spanning 3 days with varying density -->
        <div id="chart-data" class="d-none"
             data-test-values="[5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 18, 16, 14, 12, 10, 8, 6, 4, 5, 7, 9, 11, 13, 15]"
             data-test-times="[
                 '2025-07-19 06:00:00', '2025-07-19 08:00:00', '2025-07-19 10:00:00', '2025-07-19 12:00:00', '2025-07-19 14:00:00',
                 '2025-07-19 16:00:00', '2025-07-19 18:00:00', '2025-07-19 20:00:00', '2025-07-19 22:00:00',
                 '2025-07-20 02:00:00', '2025-07-20 04:00:00', '2025-07-20 06:00:00', '2025-07-20 08:00:00', '2025-07-20 10:00:00',
                 '2025-07-20 12:00:00', '2025-07-20 14:00:00', '2025-07-20 16:00:00', '2025-07-20 18:00:00', '2025-07-20 20:00:00', '2025-07-20 22:00:00',
                 '2025-07-21 01:00:00', '2025-07-21 03:00:00', '2025-07-21 05:00:00', '2025-07-21 07:00:00', '2025-07-21 09:00:00',
                 '2025-07-21 11:00:00', '2025-07-21 13:00:00', '2025-07-21 15:00:00', '2025-07-21 17:00:00', '2025-07-21 19:00:00'
             ]">
        </div>

        <div id="results"></div>
    </div>

    <script>
        function waitForChart() {
            if (typeof Chart !== 'undefined') {
                console.log('Chart.js loaded, testing multiple dates...');
                createTestChart();
            } else {
                setTimeout(waitForChart, 100);
            }
        }
        
        function getChartData(dataKey) {
            const element = document.getElementById('chart-data');
            const data = element.getAttribute(`data-${dataKey}`);
            
            if (!data || data === 'None' || data === '') return [];
            
            try {
                let cleanedData = data;
                cleanedData = cleanedData.replace(/\\u0027/g, "'");
                cleanedData = cleanedData.replace(/\\u002D/g, "-");
                cleanedData = cleanedData.replace(/'/g, '"');
                
                return JSON.parse(cleanedData);
            } catch (e) {
                console.error(`Error parsing ${dataKey}:`, e);
                return [];
            }
        }
        
        function createTestChart() {
            const values = getChartData('test-values');
            const times = getChartData('test-times');
            
            if (values.length === 0 || times.length === 0) {
                document.getElementById('results').innerHTML = '<p style="color: red;">‚ùå No data available</p>';
                return;
            }
            
            console.log(`Loaded ${values.length} data points across 3 days`);
            
            try {
                const ctx = document.getElementById('testChart').getContext('2d');
                
                const colors = {
                    primary: '#00BCD4',
                    grid: 'rgba(0,0,0,0.05)',
                    text: '#333'
                };
                
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: 'Test Data (3 Days)',
                            data: values,
                            borderColor: colors.primary,
                            backgroundColor: colors.primary + '20',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'üìä Multiple Dates Test: 19/7, 20/7, 21/7 (30 data points)',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    title: function(context) {
                                        const label = context[0].label;
                                        if (label && label.includes(' ')) {
                                            try {
                                                const [datePart, timePart] = label.split(' ');
                                                const dateObj = new Date(datePart);
                                                const day = dateObj.getDate();
                                                const month = dateObj.getMonth() + 1;
                                                const year = dateObj.getFullYear();
                                                return `${day}/${month}/${year} ${timePart}`;
                                            } catch (e) {
                                                return label;
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'category',
                                grid: {
                                    display: true,
                                    color: colors.grid
                                },
                                ticks: {
                                    color: colors.text,
                                    maxTicksLimit: 15,
                                    callback: function(value, index, values) {
                                        const label = this.getLabelForValue(value);
                                        
                                        if (!label || !label.includes(' ')) return '';
                                        
                                        const datePart = label.split(' ')[0];
                                        if (!datePart) return '';
                                        
                                        try {
                                            const dateObj = new Date(datePart);
                                            const day = dateObj.getDate();
                                            const month = dateObj.getMonth() + 1;
                                            
                                            // Always show first point
                                            if (index === 0) {
                                                console.log(`Showing first date: ${day}/${month} at index ${index}`);
                                                return `${day}/${month}`;
                                            }
                                            
                                            // Always show last point
                                            if (index === values.length - 1) {
                                                console.log(`Showing last date: ${day}/${month} at index ${index}`);
                                                return `${day}/${month}`;
                                            }
                                            
                                            // Check if this date is different from previous date
                                            const prevLabel = index > 0 ? this.getLabelForValue(index - 1) : '';
                                            if (prevLabel && prevLabel.includes(' ')) {
                                                const prevDatePart = prevLabel.split(' ')[0];
                                                if (prevDatePart !== datePart) {
                                                    console.log(`Showing new date: ${day}/${month} at index ${index} (changed from ${prevDatePart})`);
                                                    return `${day}/${month}`;
                                                }
                                            }
                                            
                                            // For data points within the same day, show some labels
                                            const totalPoints = values.length;
                                            if (totalPoints <= 10) {
                                                if (index % 2 === 0) {
                                                    console.log(`Showing interval date: ${day}/${month} at index ${index} (every 2nd)`);
                                                    return `${day}/${month}`;
                                                }
                                            } else if (totalPoints <= 30) {
                                                if (index % 5 === 0) {
                                                    console.log(`Showing interval date: ${day}/${month} at index ${index} (every 5th)`);
                                                    return `${day}/${month}`;
                                                }
                                            } else {
                                                if (index % 10 === 0) {
                                                    console.log(`Showing interval date: ${day}/${month} at index ${index} (every 10th)`);
                                                    return `${day}/${month}`;
                                                }
                                            }
                                            
                                            return '';
                                        } catch (e) {
                                            return '';
                                        }
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: true,
                                    color: colors.grid
                                },
                                ticks: {
                                    color: colors.text
                                }
                            }
                        }
                    }
                });
                
                // Count expected date labels
                const uniqueDates = [...new Set(times.map(time => time.split(' ')[0]))];
                const expectedLabels = uniqueDates.length + Math.floor(times.length / 5); // New dates + intervals
                
                document.getElementById('results').innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h3 style="color: #2e7d2e; margin: 0 0 10px 0;">‚úÖ Chart Created!</h3>
                        <p><strong>Data points:</strong> ${values.length}</p>
                        <p><strong>Unique dates:</strong> ${uniqueDates.length} (${uniqueDates.join(', ')})</p>
                        <p><strong>Expected labels:</strong> ~${expectedLabels} date labels should appear</p>
                        <p><em>Check browser console for detailed label logging</em></p>
                        <p style="margin: 0;"><strong>Look for:</strong> 19/7, 20/7, 21/7 and some intermediate dates</p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error creating test chart:', error);
                document.getElementById('results').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', waitForChart);
    </script>
</body>
</html>