<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Every 3 Days Display</title>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; }
        .info { background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #bee5eb; }
        .target-days { background: #fff3cd; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ Testing Every 3 Days Display Pattern</h1>
        
        <div class="info">
            <h3>üéØ Target Pattern:</h3>
            <div class="target-days">
                <strong>Show only these days:</strong> 1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31
            </div>
            <ul>
                <li><strong>Always show:</strong> First and last data points</li>
                <li><strong>Target days only:</strong> 1st, 4th, 7th, 10th, etc. of each month</li>
                <li><strong>No duplicates:</strong> Each date shown only once</li>
            </ul>
        </div>

        <div class="chart-container">
            <canvas id="testChart"></canvas>
        </div>
        
        <!-- Test data covering a full month -->
        <div id="chart-data" class="d-none"
             data-test-values="[10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 28, 26, 24, 22, 20, 18, 16, 14, 12, 10, 8, 6, 4, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32]"
             data-test-times="[
                 '2025-07-01 08:00:00', '2025-07-02 08:00:00', '2025-07-03 08:00:00', '2025-07-04 08:00:00', '2025-07-05 08:00:00',
                 '2025-07-06 08:00:00', '2025-07-07 08:00:00', '2025-07-08 08:00:00', '2025-07-09 08:00:00', '2025-07-10 08:00:00',
                 '2025-07-11 08:00:00', '2025-07-12 08:00:00', '2025-07-13 08:00:00', '2025-07-14 08:00:00', '2025-07-15 08:00:00',
                 '2025-07-16 08:00:00', '2025-07-17 08:00:00', '2025-07-18 08:00:00', '2025-07-19 08:00:00', '2025-07-20 08:00:00',
                 '2025-07-21 08:00:00', '2025-07-22 08:00:00', '2025-07-23 08:00:00', '2025-07-24 08:00:00', '2025-07-25 08:00:00',
                 '2025-07-26 08:00:00', '2025-07-27 08:00:00', '2025-07-28 08:00:00', '2025-07-29 08:00:00', '2025-07-30 08:00:00',
                 '2025-07-31 08:00:00', '2025-08-01 08:00:00', '2025-08-02 08:00:00', '2025-08-03 08:00:00', '2025-08-04 08:00:00',
                 '2025-08-05 08:00:00', '2025-08-06 08:00:00', '2025-08-07 08:00:00', '2025-08-08 08:00:00', '2025-08-09 08:00:00'
             ]">
        </div>

        <div id="results"></div>
    </div>

    <script>
        function waitForChart() {
            if (typeof Chart !== 'undefined') {
                console.log('Chart.js loaded, testing every 3 days pattern...');
                createTestChart();
            } else {
                setTimeout(waitForChart, 100);
            }
        }
        
        function getChartData(dataKey) {
            const element = document.getElementById('chart-data');
            const data = element.getAttribute(`data-${dataKey}`);
            
            if (!data || data === 'None' || data === '') return [];
            
            try {
                let cleanedData = data;
                cleanedData = cleanedData.replace(/\\u0027/g, "'");
                cleanedData = cleanedData.replace(/\\u002D/g, "-");
                cleanedData = cleanedData.replace(/'/g, '"');
                
                return JSON.parse(cleanedData);
            } catch (e) {
                console.error(`Error parsing ${dataKey}:`, e);
                return [];
            }
        }
        
        function createTestChart() {
            const values = getChartData('test-values');
            const times = getChartData('test-times');
            
            if (values.length === 0 || times.length === 0) {
                document.getElementById('results').innerHTML = '<p style="color: red;">‚ùå No data available</p>';
                return;
            }
            
            console.log(`Loaded ${values.length} data points for full month test`);
            
            try {
                const ctx = document.getElementById('testChart').getContext('2d');
                
                const colors = {
                    primary: '#00BCD4',
                    grid: 'rgba(0,0,0,0.05)',
                    text: '#333'
                };
                
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: 'Monthly Test Data',
                            data: values,
                            borderColor: colors.primary,
                            backgroundColor: colors.primary + '20',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'üìä Every 3 Days Pattern: Should show 1/7, 4/7, 7/7, 10/7, 13/7, 16/7, 19/7, 22/7, 25/7, 28/7, 31/7, 1/8, 4/8, 7/8',
                                font: { size: 14, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                padding: 12,
                                cornerRadius: 8,
                                callbacks: {
                                    title: function(context) {
                                        const label = context[0].label;
                                        if (label && label.includes(' ')) {
                                            try {
                                                const [datePart, timePart] = label.split(' ');
                                                const dateObj = new Date(datePart);
                                                const day = dateObj.getDate();
                                                const month = dateObj.getMonth() + 1;
                                                const year = dateObj.getFullYear();
                                                return `${day}/${month}/${year} ${timePart}`;
                                            } catch (e) {
                                                return label;
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'category',
                                grid: {
                                    display: true,
                                    color: colors.grid
                                },
                                ticks: {
                                    color: colors.text,
                                    maxTicksLimit: 15,
                                    callback: function(value, index, values) {
                                        const label = this.getLabelForValue(value);
                                        
                                        if (!label || !label.includes(' ')) return '';
                                        
                                        const datePart = label.split(' ')[0];
                                        if (!datePart) return '';
                                        
                                        try {
                                            const dateObj = new Date(datePart);
                                            const day = dateObj.getDate();
                                            const month = dateObj.getMonth() + 1;
                                            
                                            // Define target days to show (every 3 days: 1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31)
                                            const targetDays = [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31];
                                            
                                            // Always show first data point
                                            if (index === 0) {
                                                console.log(`[FIRST] Showing: ${day}/${month} at index ${index}`);
                                                return `${day}/${month}`;
                                            }
                                            
                                            // Always show last data point
                                            if (index === values.length - 1) {
                                                console.log(`[LAST] Showing: ${day}/${month} at index ${index}`);
                                                return `${day}/${month}`;
                                            }
                                            
                                            // Show only if the day matches our target days (1, 4, 7, 10, etc.)
                                            if (targetDays.includes(day)) {
                                                // Check if we haven't shown this date already
                                                let alreadyShown = false;
                                                for (let i = 0; i < index; i++) {
                                                    const prevLabel = this.getLabelForValue(i);
                                                    if (prevLabel && prevLabel.includes(' ')) {
                                                        const prevDatePart = prevLabel.split(' ')[0];
                                                        const prevDateObj = new Date(prevDatePart);
                                                        const prevDay = prevDateObj.getDate();
                                                        const prevMonth = prevDateObj.getMonth() + 1;
                                                        
                                                        // If we already showed this exact date, don't show again
                                                        if (prevDay === day && prevMonth === month) {
                                                            alreadyShown = true;
                                                            break;
                                                        }
                                                    }
                                                }
                                                
                                                if (!alreadyShown) {
                                                    console.log(`[TARGET] Showing: ${day}/${month} at index ${index} (target day)`);
                                                    return `${day}/${month}`;
                                                } else {
                                                    console.log(`[SKIP] Already shown: ${day}/${month} at index ${index}`);
                                                }
                                            }
                                            
                                            return '';
                                        } catch (e) {
                                            return '';
                                        }
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: true,
                                    color: colors.grid
                                },
                                ticks: {
                                    color: colors.text
                                }
                            }
                        }
                    }
                });
                
                // Analyze expected results
                const expectedDates = [];
                times.forEach((time, index) => {
                    const datePart = time.split(' ')[0];
                    const dateObj = new Date(datePart);
                    const day = dateObj.getDate();
                    const month = dateObj.getMonth() + 1;
                    const targetDays = [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31];
                    
                    if (index === 0 || index === times.length - 1 || targetDays.includes(day)) {
                        const dateStr = `${day}/${month}`;
                        if (!expectedDates.includes(dateStr)) {
                            expectedDates.push(dateStr);
                        }
                    }
                });
                
                document.getElementById('results').innerHTML = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <h3 style="color: #2e7d2e; margin: 0 0 10px 0;">‚úÖ Chart Created!</h3>
                        <p><strong>Data points:</strong> ${values.length} (covering July-August)</p>
                        <p><strong>Expected dates to show:</strong> ${expectedDates.join(', ')}</p>
                        <p><strong>Pattern:</strong> Every 3rd day (1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31)</p>
                        <p style="margin: 0;"><em>üìù Check browser console for detailed logging of which dates are shown</em></p>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error creating test chart:', error);
                document.getElementById('results').innerHTML = `<p style="color: red;">‚ùå Error: ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', waitForChart);
    </script>
</body>
</html>