<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Date Display on X-Axis</title>
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body>
    <h1>Testing Date Display on X-Axis</h1>
    <div style="width: 800px; height: 400px;">
        <canvas id="testChart"></canvas>
    </div>
    
    <!-- Test data spanning multiple days -->
    <div id="chart-data" class="d-none"
         data-test-values="[10, 12, 14, 11, 13, 15, 16, 18, 20, 22, 19, 17, 15, 13, 11, 14, 16, 18, 21, 23]"
         data-test-times="[
             '2025-07-17 08:00:00', '2025-07-17 12:00:00', '2025-07-17 16:00:00', '2025-07-17 20:00:00',
             '2025-07-18 02:00:00', '2025-07-18 06:00:00', '2025-07-18 10:00:00', '2025-07-18 14:00:00', '2025-07-18 18:00:00', '2025-07-18 22:00:00',
             '2025-07-19 03:00:00', '2025-07-19 07:00:00', '2025-07-19 11:00:00', '2025-07-19 15:00:00', '2025-07-19 19:00:00', '2025-07-19 23:00:00',
             '2025-07-20 04:00:00', '2025-07-20 08:00:00', '2025-07-20 12:00:00', '2025-07-20 16:00:00'
         ]">
    </div>

    <div id="debug-info"></div>

    <script>
        // Wait for Chart.js to load
        function waitForChart() {
            if (typeof Chart !== 'undefined') {
                console.log('Chart.js loaded, testing date display...');
                createTestChart();
            } else {
                setTimeout(waitForChart, 100);
            }
        }
        
        function getChartData(dataKey) {
            const element = document.getElementById('chart-data');
            const data = element.getAttribute(`data-${dataKey}`);
            
            if (!data || data === 'None' || data === '') return [];
            
            try {
                // Handle Django template escaping and parse data
                let cleanedData = data;
                cleanedData = cleanedData.replace(/\\u0027/g, "'");
                cleanedData = cleanedData.replace(/\\u002D/g, "-");
                cleanedData = cleanedData.replace(/'/g, '"');
                
                const parsedData = JSON.parse(cleanedData);
                return parsedData;
            } catch (e) {
                console.error(`Error parsing ${dataKey}:`, e);
                return [];
            }
        }
        
        function createTestChart() {
            const values = getChartData('test-values');
            const times = getChartData('test-times');
            
            console.log('Test values:', values);
            console.log('Test times:', times);
            
            if (values.length === 0 || times.length === 0) {
                document.getElementById('debug-info').innerHTML = '<p style="color: red;">No data available</p>';
                return;
            }
            
            try {
                const ctx = document.getElementById('testChart').getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: times,
                        datasets: [{
                            label: 'Test Data (Multi-day)',
                            data: values,
                            borderColor: '#00BCD4',
                            backgroundColor: '#00BCD4' + '20',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Date Display Test (17/7 - 20/7)'
                            },
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        // Show full datetime in tooltip
                                        return context[0].label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'category',
                                grid: {
                                    display: true,
                                    color: 'rgba(0,0,0,0.05)'
                                },
                                ticks: {
                                    color: '#333',
                                    maxTicksLimit: 15,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        
                                        if (!label || !label.includes(' ')) return '';
                                        
                                        // Extract date from datetime string (YYYY-MM-DD HH:MM:SS)
                                        const datePart = label.split(' ')[0]; // Get YYYY-MM-DD
                                        
                                        if (!datePart) return '';
                                        
                                        try {
                                            // Convert to readable date format
                                            const dateObj = new Date(datePart);
                                            const day = dateObj.getDate();
                                            const month = dateObj.getMonth() + 1; // Months are 0-indexed
                                            
                                            // Show only if it's the start of a new day (first occurrence)
                                            if (index === 0) {
                                                return `${day}/${month}`;
                                            }
                                            
                                            // Check if this date is different from previous date
                                            const prevLabel = index > 0 ? this.getLabelForValue(index - 1) : '';
                                            if (prevLabel && prevLabel.includes(' ')) {
                                                const prevDatePart = prevLabel.split(' ')[0];
                                                if (prevDatePart !== datePart) {
                                                    return `${day}/${month}`;
                                                }
                                            }
                                            
                                            return '';
                                        } catch (e) {
                                            return '';
                                        }
                                    }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                grid: {
                                    display: true,
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            }
                        }
                    }
                });
                
                console.log('Test chart created successfully!');
                document.getElementById('debug-info').innerHTML = `
                    <h3>Chart Created Successfully!</h3>
                    <p><strong>Data points:</strong> ${values.length}</p>
                    <p><strong>Date range:</strong> 17/7 - 20/7</p>
                    <p><strong>X-axis shows:</strong> Day/Month format (only when date changes)</p>
                    <p><strong>Tooltip shows:</strong> Full datetime when you hover over points</p>
                `;
                
            } catch (error) {
                console.error('Error creating test chart:', error);
                document.getElementById('debug-info').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            }
        }

        // Start when DOM is ready
        document.addEventListener('DOMContentLoaded', waitForChart);
    </script>
</body>
</html>