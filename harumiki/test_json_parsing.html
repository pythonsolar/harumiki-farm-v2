<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test JSON Parsing Fix</title>
</head>
<body>
    <h1>Testing Django escapejs JSON Parsing</h1>
    
    <!-- Simulate problematic Django template data -->
    <div id="chart-data" class="d-none"
         data-test-times="[\u00272025-07-19 17:06:58\u0027, \u00272025-07-19 17:21:58\u0027, \u00272025-07-19 17:36:58\u0027]"
         data-test-values="[1, 2, \u002D3, 4.5, \u002D6.7]">
    </div>

    <div id="results"></div>

    <script>
        function sanitizeDataKey(key) {
            if (typeof key !== 'string') return null;
            return key.replace(/[^a-zA-Z0-9-_]/g, '');
        }

        function getChartData(dataKey) {
            const sanitizedKey = sanitizeDataKey(dataKey);
            if (!sanitizedKey) {
                console.error('Invalid data key:', dataKey);
                return [];
            }
            
            const element = document.getElementById('chart-data');
            if (!element) {
                console.error('Chart data element not found');
                return [];
            }
            
            const data = element.getAttribute(`data-${sanitizedKey}`);
            
            if (!data || data === 'None' || data === '') return [];
            
            try {
                // Handle Django template escaping and parse data
                let cleanedData = data;
                
                // Handle Django's escapejs filter output
                cleanedData = cleanedData.replace(/\\u0027/g, "'");  // Replace \u0027 with '
                cleanedData = cleanedData.replace(/\\u002D/g, "-");  // Replace \u002D with -
                cleanedData = cleanedData.replace(/'/g, '"');        // Replace ' with "
                
                console.log(`Original data for ${dataKey}:`, data);
                console.log(`Cleaned data for ${dataKey}:`, cleanedData);
                
                const parsedData = JSON.parse(cleanedData);
                console.log(`Parsed data for ${dataKey}:`, parsedData);
                
                return parsedData;
                
            } catch (e) {
                console.error(`Error parsing ${dataKey}:`, e);
                return [];
            }
        }

        function testParsing() {
            const resultsDiv = document.getElementById('results');
            let html = '<h2>JSON Parsing Test Results</h2>';
            
            // Test times with escaped quotes
            const times = getChartData('test-times');
            html += `<h3>Test Times</h3>`;
            html += `<p><strong>Success:</strong> ${times.length > 0 ? 'YES' : 'NO'}</p>`;
            html += `<p><strong>Data:</strong> ${JSON.stringify(times)}</p>`;
            
            // Test values with negative numbers
            const values = getChartData('test-values');
            html += `<h3>Test Values</h3>`;
            html += `<p><strong>Success:</strong> ${values.length > 0 ? 'YES' : 'NO'}</p>`;
            html += `<p><strong>Data:</strong> ${JSON.stringify(values)}</p>`;
            
            // Overall result
            const success = times.length > 0 && values.length > 0;
            html += `<h3>Overall Result</h3>`;
            html += `<p style="color: ${success ? 'green' : 'red'}; font-weight: bold;">
                ${success ? 'SUCCESS: JSON parsing fix works!' : 'FAILED: JSON parsing still has issues'}
            </p>`;
            
            resultsDiv.innerHTML = html;
        }

        // Run test when page loads
        document.addEventListener('DOMContentLoaded', testParsing);
    </script>
</body>
</html>